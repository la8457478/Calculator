<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸè´§è¡Œæƒ… - Trading Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* Only showing styles relevant to the new chart feature + existing styles */
        /* ... Existing Styles ... */
        .futures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 16px;
            padding: 16px 0;
        }

        .futures-card {
            background: var(--card-bg, rgba(255, 255, 255, 0.05));
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color, rgba(255, 255, 255, 0.1));
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            /* Indicate clickable */
        }

        .futures-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-color, #6366f1);
        }

        .futures-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .futures-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary, #fff);
        }

        .futures-code {
            font-size: 0.85rem;
            color: var(--text-secondary, #888);
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .contracts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .contract-box {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
        }

        .contract-box.main {
            border-left: 3px solid #6366f1;
        }

        .contract-box.sub {
            border-left: 3px solid #8b5cf6;
        }

        .contract-box.disabled {
            opacity: 0.5;
        }

        .contract-label {
            font-size: 0.75rem;
            color: var(--text-secondary, #888);
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .contract-symbol {
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 1px 4px;
            border-radius: 3px;
        }

        .contract-price {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .kdj-mini {
            display: flex;
            gap: 8px;
            margin-bottom: 6px;
        }

        .kdj-mini-item {
            font-size: 0.8rem;
        }

        .kdj-k {
            color: #f59e0b;
        }

        .kdj-d {
            color: #3b82f6;
        }

        .kdj-j {
            color: #a855f7;
        }

        .kdj-pattern {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .kdj-pattern.bullish {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .kdj-pattern.bearish {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .kdj-pattern.neutral {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .kdj-pattern.overbought {
            background: rgba(239, 68, 68, 0.3);
            color: #fca5a5;
        }

        .kdj-pattern.oversold {
            background: rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        .rule-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 4px;
            margin-top: 4px;
        }

        .rule-tag.long {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .rule-tag.short {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .rule-tag.pending_long {
            background: rgba(251, 191, 36, 0.2);
            color: #f59e0b;
            border: 1px solid #f59e0b;
        }

        .rule-tag.pending_short {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
            border: 1px solid #9ca3af;
        }

        /* Pending Highlight (Red Box) */
        .contract-box.pending-highlight {
            border: 2px solid #ef4444 !important;
            background: rgba(239, 68, 68, 0.05);
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.25);
            position: relative;
        }

        /* Optional: Add a small corner label or indicator if needed, but user wanted minimal text */

        .update-time {
            font-size: 0.7rem;
            color: var(--text-secondary, #888);
            text-align: right;
            margin-top: 12px;
        }

        /* Filter & Summary Styles */
        .filter-section {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-color, rgba(255, 255, 255, 0.2));
            background: transparent;
            color: var(--text-secondary, #888);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .filter-btn.active {
            background: var(--primary-color, #6366f1);
            color: white;
            border-color: var(--primary-color, #6366f1);
        }

        .summary-bar {
            display: flex;
            gap: 24px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
        }

        .summary-label {
            font-size: 0.8rem;
            color: var(--text-secondary, #888);
        }

        .summary-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .summary-value.bullish {
            color: #22c55e;
        }

        .summary-value.bearish {
            color: #ef4444;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #1e1e1e;
            margin: 5% auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 90%;
            max-width: 1000px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: white;
        }

        #chartContainer {
            width: 100%;
            height: 100%;
            flex-grow: 1;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.02);
        }

        .chart-tab {
            padding: 6px 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .chart-tab.active {
            background: #6366f1;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Trading Calculator</h1>
            <p class="subtitle">æœŸè´§å‘¨çº¿è¡Œæƒ… & KDJ æŒ‡æ ‡ï¼ˆä¸»åŠ› + æ¬¡ä¸»åŠ›ï¼‰</p>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <a href="index.html" class="tab-button" data-i18n="tabCalc">ğŸ–¥ï¸ è®¡ç®—å™¨</a>
            <a href="history.html" class="tab-button" data-i18n="tabHistory">ğŸ“ å†å²è®°å½•</a>
            <a href="positions.html" class="tab-button" data-i18n="tabPositions">ğŸ“Š æŒä»“ç®¡ç†</a>
            <a href="futures.html" class="tab-button active">ğŸ“ˆ æœŸè´§è¡Œæƒ…</a>
            <a href="stocks_quarterly.html" class="tab-button">ğŸ“Š è‚¡ç¥¨å­£çº¿</a>
        </div>

        <!-- Futures Content -->
        <div class="tab-content active" style="display: block;">
            <!-- Summary Bar -->
            <div class="summary-bar" id="summaryBar"></div>

            <!-- Filter Section -->
            <div class="filter-section">
                <button class="filter-btn active" onclick="filterFutures('all', this)">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="filterFutures('pattern2_pending', this)">S2: è“„åŠ¿</button>
            </div>

            <!-- Futures Grid -->
            <div class="futures-grid" id="futuresGrid"></div>
        </div>

        <footer>
            <p>&copy; 2026 Trading Calculator</p>
        </footer>
    </div>

    <!-- Chart Modal -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" id="modalTitle">Kçº¿å›¾</span>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div class="chart-controls">
                <div class="chart-tab active" id="btnMain" onclick="switchChartContract('main')">ä¸»åŠ›åˆçº¦</div>
                <div class="chart-tab" id="btnSub" onclick="switchChartContract('sub')">æ¬¡ä¸»åŠ›åˆçº¦</div>
            </div>
            <div id="chartContainer"></div>
        </div>
    </div>

    <script src="futures_specs.js"></script>
    <script src="futures_data.js"></script>
    <script>
        let currentFilter = 'all';
        let chartInstance = null;
        let currentFutureCode = null;
        let currentContractType = 'main'; // 'main' or 'sub'

        document.addEventListener('DOMContentLoaded', function () {
            renderSummary();
            renderFuturesGrid();

            // Window resize handle
            window.addEventListener('resize', function () {
                if (chartInstance) chartInstance.resize();
            });

            // Close modal on click outside
            const modal = document.getElementById('chartModal');
            window.onclick = function (event) {
                if (event.target == modal) {
                    closeModal();
                }
            }
        });

        function renderSummary() {
            const summaryBar = document.getElementById('summaryBar');
            if (typeof FUTURES_DATA === 'undefined' || !FUTURES_DATA) return;

            let mainBullish = 0, mainBearish = 0;
            let subBullish = 0, subBearish = 0;
            let total = Object.keys(FUTURES_DATA).length;
            let hasSubCount = 0;

            Object.values(FUTURES_DATA).forEach(future => {
                // ä¸»åŠ›ç»Ÿè®¡
                if (future.main?.latestKDJ?.pattern) {
                    if (future.main.latestKDJ.pattern.includes('å¤šå¤´')) mainBullish++;
                    if (future.main.latestKDJ.pattern.includes('ç©ºå¤´')) mainBearish++;
                }
                // æ¬¡ä¸»åŠ›ç»Ÿè®¡
                if (future.sub?.latestKDJ?.pattern) {
                    hasSubCount++;
                    if (future.sub.latestKDJ.pattern.includes('å¤šå¤´')) subBullish++;
                    if (future.sub.latestKDJ.pattern.includes('ç©ºå¤´')) subBearish++;
                }
            });

            summaryBar.innerHTML = `
                <div class="summary-item">
                    <span class="summary-label">å“ç§æ€»æ•°</span>
                    <span class="summary-value">${total}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ä¸»åŠ›å¤šå¤´</span>
                    <span class="summary-value bullish">${mainBullish}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">ä¸»åŠ›ç©ºå¤´</span>
                    <span class="summary-value bearish">${mainBearish}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ¬¡ä¸»åŠ›å¤šå¤´</span>
                    <span class="summary-value bullish">${subBullish}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æ¬¡ä¸»åŠ›ç©ºå¤´</span>
                    <span class="summary-value bearish">${subBearish}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">æœ‰æ¬¡ä¸»åŠ›</span>
                    <span class="summary-value">${hasSubCount}/${total}</span>
                </div>
            `;
        }

        function filterFutures(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderFuturesGrid();
        }

        function getPatternClass(pattern) {
            if (!pattern) return 'neutral';
            if (pattern.includes('å¤šå¤´')) return 'bullish';
            if (pattern.includes('ç©ºå¤´')) return 'bearish';
            if (pattern.includes('è¶…ä¹°')) return 'overbought';
            if (pattern.includes('è¶…å–')) return 'oversold';
            return 'neutral';
        }

        function renderContractBox(contract, type, futureCode) {
            if (!contract) {
                return `
                    <div class="contract-box ${type} disabled">
                        <div class="contract-label">
                            <span>${type === 'main' ? 'ä¸»åŠ›åˆçº¦' : 'æ¬¡ä¸»åŠ›åˆçº¦'}</span>
                        </div>
                        <div class="no-data">æš‚æ— æ•°æ®</div>
                    </div>
                `;
            }

            const latestData = contract.data[contract.data.length - 1];
            const kdj = contract.latestKDJ;

            // æ›´æ–°ï¼šè“„åŠ¿åˆ¤æ–­éœ€è¦éªŒè¯KDJé‡‘å‰/æ­»å‰
            let isPending = false;
            if (kdj.custom_rule_2?.includes('pending')) {
                const k = kdj.K;
                const d = kdj.D;
                // åšå¤šè“„åŠ¿å¿…é¡»é‡‘å‰ï¼Œåšç©ºè“„åŠ¿å¿…é¡»æ­»å‰
                if (kdj.custom_rule_2 === 'pending_long' && k > d) {
                    isPending = true;
                } else if (kdj.custom_rule_2 === 'pending_short' && k < d) {
                    isPending = true;
                }
            }

            let patternClass = '';
            if (kdj.pattern.includes('å¤šå¤´')) patternClass = 'bullish';
            else if (kdj.pattern.includes('ç©ºå¤´')) patternClass = 'bearish';

            // Rule tags
            let ruleTags = '';
            if (kdj.custom_rule_1) {
                const r1Map = {
                    'long': 'S1: å¤è‹',
                    'short': 'S1: è½¬å¼±'
                };
                const label = r1Map[kdj.custom_rule_1] || kdj.custom_rule_1;
                if (label) {
                    const cls = kdj.custom_rule_1;
                    ruleTags += `<span class="rule-tag ${cls}">${label}</span>`;
                }
            }

            if (kdj.custom_rule_2) {
                const r2Map = {
                    'long': 'S2: çªç ´',
                    'short': 'S2: ç ´ä½',
                    'pending_long': 'S2: è“„åŠ¿',
                    'pending_short': 'S2: è“„åŠ¿'
                };
                const label = r2Map[kdj.custom_rule_2] || kdj.custom_rule_2;
                if (label) {
                    // åªæœ‰é€šè¿‡KDJéªŒè¯çš„pendingæ‰æ˜¾ç¤ºæ ‡ç­¾
                    if (kdj.custom_rule_2.includes('pending')) {
                        if (isPending) {  // åªæœ‰isPendingä¸ºtrueæ‰æ˜¾ç¤º
                            const cls = kdj.custom_rule_2;
                            ruleTags += `<span class="rule-tag ${cls}">${label}</span>`;
                        }
                    } else {
                        const cls = kdj.custom_rule_2;
                        ruleTags += `<span class="rule-tag ${cls}">${label}</span>`;
                    }
                }
            }

            let pendingInfo = '';
            if (isPending && contract.data.length >= 2) {
                const w2 = contract.data[contract.data.length - 2];
                const w3 = contract.data[contract.data.length - 1]; // latestData
                let breakoutPrice, stopPrice, typeLabel;

                if (kdj.custom_rule_2 === 'pending_long') {
                    breakoutPrice = w2.high;
                    stopPrice = w3.low;
                    typeLabel = 'çªç ´ä¹°å…¥';
                } else if (kdj.custom_rule_2 === 'pending_short') {
                    breakoutPrice = w2.low;
                    stopPrice = w3.high;
                    typeLabel = 'ç ´ä½å–å‡º';
                }

                if (breakoutPrice !== undefined) {
                    const uniqueId = `${contract.symbol}_${type}`;
                    pendingInfo = `
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed rgba(255,255,255,0.2); font-size: 0.8rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #bbb;">${typeLabel}:</span>
                                <span style="color: #fff; font-weight: 600;">${breakoutPrice.toFixed(1)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #bbb;">æ­¢æŸä»·æ ¼:</span>
                                <span style="color: #fff; font-weight: 600;">${stopPrice.toFixed(1)}</span>
                            </div>
                            
                            <!-- Inline Calculator -->
                            <div style="margin-top: 8px; display: flex; align-items: center; gap: 4px;" onclick="event.stopPropagation()">
                                <label style="color: #bbb; font-size: 0.75rem;">é£é™©(Â¥):</label>
                                <input type="number" id="risk_${uniqueId}" placeholder="3000" list="riskOptions" style="width: 70px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 4px; padding: 2px 4px; font-size: 0.75rem;" onclick="event.stopPropagation()">
                                <button onclick="event.stopPropagation(); calculatePendingPosition('${contract.symbol}', '${uniqueId}', ${breakoutPrice}, ${stopPrice}, '${futureCode}')" style="background: #6366f1; color: white; border: none; border-radius: 4px; padding: 2px 6px; font-size: 0.75rem; cursor: pointer;">è®¡ç®—</button>
                            </div>
                            <div id="result_${uniqueId}" style="margin-top: 4px; font-size: 0.75rem; color: #22c55e; display: none;"></div>
                        </div>
                    `;
                }
            }

            return `
                <div class="contract-box ${type} ${isPending ? "pending-highlight" : ""}"> 
                    <div class="contract-label">
                        <span>${type === 'main' ? 'ä¸»åŠ›åˆçº¦' : 'æ¬¡ä¸»åŠ›åˆçº¦'}</span>
                        <span class="contract-symbol">${contract.symbol}</span>
                    </div>
                    <div class="contract-price">${latestData.close.toFixed(1)}</div>
                    <div class="kdj-mini">
                        <span class="kdj-mini-item kdj-k">K: ${kdj.K.toFixed(1)}</span>
                        <span class="kdj-mini-item kdj-d">D: ${kdj.D.toFixed(1)}</span>
                        <span class="kdj-mini-item kdj-j">J: ${kdj.J.toFixed(1)}</span>
                    </div>
                    <span class="kdj-pattern ${patternClass}">${kdj.pattern}</span>
                    <div style="margin-top:4px;">${ruleTags}</div>
                    ${pendingInfo}
                </div>
            `;
        }

        function calculatePendingPosition(symbol, uniqueId, entryPrice, stopPrice, activeCode) {
            // Find product specs
            // activeCode might be passed or we can find it from FUTURES_DATA if we iterate
            // But better to pass it. I added 'activeCode' arg above but I need to make sure 'future' is available in renderContractBox scope?
            // Wait, 'future' is NOT available in renderContractBox scope in previous code.
            // I need to change renderContractBox signature or find it.
            // renderContractBox(future.main, 'main') -> I should pass future code too?
            // Actually 'contract.symbol' usually contains the code (e.g. C2605 -> C). 
            // But specs are keyed by 'C', 'RB' etc.
            // Let's try to extract code from symbol (letters part).

            let productCode = activeCode;
            if (!productCode) {
                // heuristic extraction
                const match = symbol.match(/^[A-Za-z]+/);
                if (match) productCode = match[0].toUpperCase();
            }

            const product = futuresData[productCode];
            const riskInput = document.getElementById(`risk_${uniqueId}`);
            const resultDiv = document.getElementById(`result_${uniqueId}`);

            if (!product || !riskInput || !resultDiv) {
                console.error("Missing data for calculation");
                return;
            }

            const risk = parseFloat(riskInput.value) || 3000;
            if (risk <= 0) {
                resultDiv.innerHTML = "è¯·è¾“å…¥æœ‰æ•ˆé£é™©é‡‘é¢";
                resultDiv.style.display = "block";
                resultDiv.style.color = "#ef4444";
                return;
            }

            const priceDiff = Math.abs(entryPrice - stopPrice);
            if (priceDiff === 0) {
                resultDiv.innerHTML = "å·®ä»·ä¸º0";
                resultDiv.style.display = "block";
                return;
            }

            const riskPerPoint = priceDiff / product.tickSize;
            const valuePerTick = product.tickSize * product.multiplier;
            const riskPerContract = riskPerPoint * valuePerTick;

            const contracts = Math.floor(risk / riskPerContract);
            const actualRisk = contracts * riskPerContract;
            const margin = contracts * entryPrice * product.multiplier * 0.1; // Est 10%

            resultDiv.innerHTML = `
                <div>å»ºè®®ä»“ä½: <strong>${contracts}</strong> æ‰‹</div>
                <div>å®é™…é£é™©: Â¥${actualRisk.toFixed(0)}</div>
                <div>é¢„ä¼°ä¿è¯é‡‘: Â¥${margin.toFixed(0)}</div>
            `;
            resultDiv.style.display = "block";
            resultDiv.style.color = "#22c55e";
        }

        function renderFuturesGrid() {
            const grid = document.getElementById('futuresGrid');
            if (typeof FUTURES_DATA === 'undefined' || !FUTURES_DATA) {
                grid.innerHTML = '<p class="no-data">æ— æ•°æ®ï¼Œè¯·è¿è¡Œ fetch_futures.py è·å–æ•°æ®</p>';
                return;
            }

            let futures = Object.values(FUTURES_DATA);

            // åº”ç”¨ç­›é€‰ï¼ˆåŸºäºä¸»åŠ›åˆçº¦ï¼‰
            if (currentFilter !== 'all') {
                futures = futures.filter(f => {
                    const pattern = f.main?.latestKDJ?.pattern || '';
                    switch (currentFilter) {
                        case 'bullish': return pattern.includes('å¤šå¤´');
                        case 'bearish': return pattern.includes('ç©ºå¤´');
                        case 'pattern1': return (f.main?.latestKDJ?.custom_rule_1 != null || f.sub?.latestKDJ?.custom_rule_1 != null);
                        case 'pattern2': return (['long', 'short'].includes(f.main?.latestKDJ?.custom_rule_2) || ['long', 'short'].includes(f.sub?.latestKDJ?.custom_rule_2));
                        case 'pattern2_pending':
                            // æ–°è§„åˆ™ï¼šè“„åŠ¿å¿…é¡»éªŒè¯KDJé‡‘å‰/æ­»å‰
                            const checkPending = (contract) => {
                                if (!contract?.latestKDJ?.custom_rule_2) return false;
                                const rule = contract.latestKDJ.custom_rule_2;
                                if (!rule.includes('pending')) return false;

                                const k = contract.latestKDJ.K;
                                const d = contract.latestKDJ.D;

                                // åšå¤šè“„åŠ¿å¿…é¡»é‡‘å‰(K>D)ï¼Œåšç©ºè“„åŠ¿å¿…é¡»æ­»å‰(K<D)
                                if (rule === 'pending_long') return k > d;
                                if (rule === 'pending_short') return k < d;
                                return false;
                            };
                            return checkPending(f.main) || checkPending(f.sub);
                        default: return true;
                    }
                });
            }

            // æ’åº: å°† Pending (è“„åŠ¿) çŠ¶æ€çš„å•†å“æ’åœ¨æœ€å‰é¢
            futures.sort((a, b) => {
                const isPendingA = (a.main?.latestKDJ?.custom_rule_2 || '').includes('pending') || (a.sub?.latestKDJ?.custom_rule_2 || '').includes('pending');
                const isPendingB = (b.main?.latestKDJ?.custom_rule_2 || '').includes('pending') || (b.sub?.latestKDJ?.custom_rule_2 || '').includes('pending');
                if (isPendingA && !isPendingB) return -1;
                if (!isPendingA && isPendingB) return 1;
                return 0; // ä¿æŒåŸæœ‰é¡ºåº
            });

            if (futures.length === 0) {
                grid.innerHTML = '<p class="no-data">æ— åŒ¹é…çš„æœŸè´§å“ç§</p>';
                return;
            }

            grid.innerHTML = futures.map(future => {
                const updateTime = future.main?.lastUpdate || future.sub?.lastUpdate || '';

                return `
                    <div class="futures-card" onclick="openChart('${future.code}')">
                        <div class="futures-card-header">
                            <span class="futures-name">${future.name}</span>
                            <span class="futures-code">${future.code}</span>
                        </div>
                        <div class="contracts-container">
                            ${renderContractBox(future.main, 'main', future.code)}
                            ${renderContractBox(future.sub, 'sub', future.code)}
                        </div>
                        <div class="update-time">æ›´æ–°: ${updateTime} <span style="margin-left:8px; color:#6366f1;">ğŸ“‰ ç‚¹å‡»æŸ¥çœ‹å‘¨çº¿å›¾</span></div>
                    </div>
                `;
            }).join('');
        }

        // ================= Chart Functions =================

        function openChart(code) {
            currentFutureCode = code;
            currentContractType = 'main'; // Reset to main contract

            const future = FUTURES_DATA[code];
            if (!future) return;

            // Update UI buttons
            const btnMain = document.getElementById('btnMain');
            const btnSub = document.getElementById('btnSub');

            btnMain.style.display = future.main ? 'block' : 'none';
            btnSub.style.display = future.sub ? 'block' : 'none';

            if (!future.main && future.sub) currentContractType = 'sub';

            updateChartUI();

            document.getElementById('chartModal').style.display = 'block';

            // Initialize chart if needed
            if (!chartInstance) {
                chartInstance = echarts.init(document.getElementById('chartContainer'));
            }

            renderChart();
        }

        function closeModal() {
            document.getElementById('chartModal').style.display = 'none';
        }

        function switchChartContract(type) {
            currentContractType = type;
            updateChartUI();
            renderChart();
        }

        function updateChartUI() {
            document.getElementById('btnMain').className = `chart-tab ${currentContractType === 'main' ? 'active' : ''}`;
            document.getElementById('btnSub').className = `chart-tab ${currentContractType === 'sub' ? 'active' : ''}`;
        }

        function renderChart() {
            if (!currentFutureCode || !chartInstance) return;

            const future = FUTURES_DATA[currentFutureCode];
            const contract = future[currentContractType];

            if (!contract || !contract.data || contract.data.length === 0) {
                chartInstance.clear();
                return;
            }

            document.getElementById('modalTitle').innerText = `${future.name} - ${contract.symbol} (å‘¨çº¿)`;

            // Prepare Data
            const dates = contract.data.map(item => item.date);
            const ohlc = contract.data.map(item => [item.open, item.close, item.low, item.high]);
            const k = contract.data.map(item => item.K);
            const d = contract.data.map(item => item.D);
            const j = contract.data.map(item => item.J);

            const option = {
                backgroundColor: '#1e1e1e',
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'cross' }
                },
                grid: [
                    { left: '3%', right: '3%', height: '55%', top: '5%' },
                    { left: '3%', right: '3%', top: '65%', height: '30%' }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: true,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: dates,
                        scale: true,
                        boundaryGap: true,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false }
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: { show: true, areaStyle: { color: ['rgba(255,255,255,0.02)', 'rgba(255,255,255,0.05)'] } },
                        splitLine: { lineStyle: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        axisTick: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    { type: 'inside', xAxisIndex: [0, 1], start: 0, end: 100 },
                    { show: true, xAxisIndex: [0, 1], type: 'slider', bottom: 10, start: 0, end: 100, textStyle: { color: '#888' } }
                ],
                series: [
                    {
                        name: 'Kçº¿',
                        type: 'candlestick',
                        data: ohlc,
                        itemStyle: {
                            color: '#ef4444',
                            color0: '#22c55e',
                            borderColor: '#ef4444',
                            borderColor0: '#22c55e'
                        }
                    },
                    {
                        name: 'K',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: k,
                        itemStyle: { color: '#f59e0b' },
                        symbol: 'none',
                        lineStyle: { width: 1 }
                    },
                    {
                        name: 'D',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: d,
                        itemStyle: { color: '#3b82f6' },
                        symbol: 'none',
                        lineStyle: { width: 1 }
                    },
                    {
                        name: 'J',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: j,
                        itemStyle: { color: '#a855f7' },
                        symbol: 'none',
                        lineStyle: { width: 1 }
                    }
                ]
            };

            chartInstance.setOption(option);
        }
    </script>
    <datalist id="riskOptions">
        <option value="1000">
        <option value="2000">
        <option value="3000">
        <option value="4000">
        <option value="5000">
        <option value="6000">
        <option value="7000">
        <option value="8000">
        <option value="9000">
        <option value="10000">
        <option value="12000">
        <option value="15000">
        <option value="18000">
        <option value="20000">
    </datalist>
</body>

</html>